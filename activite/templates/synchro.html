{% extends 'base.html'%}
{% load static %}
{% block "main_content" %}
<div id="app">
  <div class="row">
    <div class="col-4">
      <div class="card card-outline card-primary">
        <div class="card-header">
          <h3 class="card-title">Lecture des données de Cegid Y2 XRP Sprint</h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <a href="#" class="btn btn-primary" v-on:click="getDataXrp" v-bind:class="{ 'disabled': loader }"><i class="fas fa-cloud-download-alt"></i> Synchro XRP Sprint</a>
              <a href="#" class="btn btn-primary" v-if="loader"><i class="fas fa-sync-alt fa-spin"></i></a>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <span><pre>${synchroLog}</pre></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock "main_content"%}
{% block "footer_js" %}
<script src="{% static 'vuejs/vue.js' %}"></script>
<script>

var app = new Vue({
  el: '#app',
  delimiters: ['${','}'],
  data() {
    return({
      // loader
      loader: false,
      synchroLog: "",
    });
  },

  methods: {
    async getDataXrp() {
      self = this;
      self.loader = true;
      self.synchroLog = "";
      self.synchroLog += "Synchronisation des Familles d'articles...";
      await fetch("/act/ajax_update_famille_article/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      this.synchroLog += "Synchronisation des Services...";
      await fetch("/act/ajax_update_service/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      this.synchroLog += "Synchronisation des Postes ...";
      await fetch("/act/ajax_update_poste/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      this.synchroLog += "Synchronisation des Salariés...";
      await fetch("/act/ajax_update_salaries/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      this.synchroLog += "Synchronisation des Rubriques ...";
      await fetch("/act/ajax_update_rubrique/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      // TODO : ici si possible alimentation de la tablette des rubriques en GA
      this.synchroLog += "Synchronisation des Articles ...";
      await fetch("/act/ajax_update_article/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      this.synchroLog += "Synchronisation des Adhérents ...";
      await fetch("/act/ajax_update_adherent/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      this.synchroLog += "Synchronisation des Mises à disposition ...";
      await fetch("/act/ajax_update_mad/").then(function (response) {
        return response.json();
      }).then(function (result) {
        self.synchroLog += result.result + "(" + result.count + ")\n";
      });
      self.loader = false;
    },
  },

});


</script>
{% endblock "footer_js"%}